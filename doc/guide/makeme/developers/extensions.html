<!-- BeginDsi "dsi/head.html" -->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Embedthis MakeMe 0.8.0 Documentation</title>
    <meta name="keywords" content="MakeMe, Bit, GYP, autoconf"/>
	<meta name="description" content="Embedthis MakeMe -- Fast, modern replacement for make and autoconf."/>
	<meta name="robots" content="index,follow" />
	<link href="../../../doc.css" rel="stylesheet" type="text/css" />
	<link href="../../../print.css" rel="stylesheet" type="text/css" media="print"/>
    <!--[if IE]>
    <link href="../../../iehacks.css" rel="stylesheet" type="text/css" />
    </![endif]-->
    <link href="http://www.google.com/cse/style/look/default.css" type="text/css" rel="stylesheet" />
</head>

<body>
    <div class="top">
        <a class="logo"  href="http://embedthis.com/">&nbsp;</a>
        <div class="topRight">
            <div class="search">
                <div id="cse-search-form">Loading</div>
                <div class="version">Embedthis MakeMe 0.8.0</div>
            </div>
        </div>
        <div class="crumbs">
            <a href="../../../index.html">Home</a>
<!-- EndDsi -->
             &gt;<a href="index.html">Developer Guide</a>&gt; <b>Creating Extensions</b>
        </div>
    </div>
    <div class="content">
        <div class="contentRight">
            
                <h1>Quick Nav </h1>
                <ul>
                    <li><a href="#configure">Creating</a></li>
                </ul>
<!-- BeginDsi "dsi/devSeeAlso.html" -->
            <h1>See Also</h1>
            <ul>
                <li><a href="../../../guide/makeme/developers/index.html">Dev Guide</a></li>
                <li><a href="../../../guide/makeme/developers/projects.html">MakeMe Projects</a></li>
                <li><a href="../../../guide/makeme/developers/compiling.html">Compiling Sources</a></li>
                <li><a href="../../../guide/makeme/developers/libraries.html">Creating Libraries</a></li>
                <li><a href="../../../guide/makeme/developers/executables.html">Building Executables</a></li>
                <li><a href="../../../guide/makeme/developers/scripts.html">Running Scripts</a></li>
                <li><a href="../../../guide/makeme/developers/copying.html">Copying Files</a></li>
                <li><a href="../../../guide/makeme/developers/creating.html">Creating a Project</a></li>
                <li><a href="../../../guide/makeme/developers/extensions.html">Creating Extensions</a></li>
                <li><a href="../../../guide/makeme/developers/generating.html">Generating Projects</a></li>
                <li><a href="../../../guide/makeme/developers/samples.html">MakeMe Samples</a></li>

                <li><a href="http://ejscript.org/products/ejs/doc/api/ejscript/index.html">Ejscript Language</a></li>
                <li><a href="http://ejscript.org/products/ejs/doc/index.html">Ejscript Documentation</a></li>
            </ul>
<!-- EndDsi -->
        </div>
        <div class="contentLeft">
        <h2>Creating Extensions</h2>
        <p>A project built by MakeMe, may be extended by the discovery and inclusion of extensions. These are modules that
        contribute libraries, files or other components to your project to extend core functionality. Examples are:
        the ESP web framework, OpenSSL SSL stack, or simple tools like the htmlmin compressor.</p>
        <p>Extensions are located and defined when users run <em>configure</em> before building the product. To locate
        extensions, MakeMe uses extension <em>probes</em> which are MakeMe scripts that locate and configure the extension.
   
        <p>When creating a product, you specify the set of extensions in the product's <em>main.me</em> file. For example:</p>
<pre>
settings: {
    extensions: {
        required: [ 'pcre' ],
        discover: [ 'cgi', 'dir', 'doxygen', 'dsi', 'esp', 'est', 'php', 'sqlite'],
        omitted:  [ 'openssl' ],
    }
},
</pre>
        <p>When configure is run, it consults these fields to determine which extensions to include.</p>
        <h3>Required, Discoverable and Optional Extensions</h3>
        <p>Extensions are designated as either <em>required</em>, <em>discoverable</em> or <em>omitted</em>. 
        Required extensions are essential for the basic operation of the product. Discoverable extensions are optional
        extensions for which MakeMe will search the local system to see if the extension is present. Omitted extensions
        will not be automatically discovered and must be explicitly requested by the user when configuring: </p> <pre>
configure -with EXTENSION
configure -with EXTENSION=/path/to/extension</pre>

        <h2>Extension Probes</h2>
        <p>Extensions are located and configured via special scripts called extension probes. These are Javascript
        object definitions that are loaded and run by MakeMe during configuration. An extension probe may be specified
        in a stand-alone script file under the <em>makeme/probes</em> directory or via probe properties in an 
        extension Pak under the <em>src/paks</em> directory.MakeMe provides a standard set of probes for common 
        tools and libraries.</p>

        <p>When the probe is run, it searches for the extension resources to test if the extension is available on the system. 
        MakeMe then creates a property collection for the extension under <em>me.extensions</em> that fully describes the
        extension, its location and how to build with it. This collection is also copied to <em>me.targets</em> so that any build
        target can depend upon the extension to inherit its build settings.</p>

        <h2>Creating Extensions</h2>
        <p>Product extensions may be delivered via one of two mechanisms:</p>
        <ul>
            <li>Stand-alone probe script</li>
            <li>Extension Paks</li>
        </ul>

        <h3>Probe Scripts</h3>
        <p>An extension that is already on the user's system, such as a system library or command line utility, may be located 
        via a stand-alone probe script. If the extension is referenced in the main.me extensions property, MakeMe will 
        search for a script of the same name as the extension under the '<em>makeme/probes</em>' directory.</p>

        <p>The probe script supplies the probe definition to the <em>Me.extension</em> function. For example:</p>
<pre>
Me.extension({
    php: {
        description: 'PHP Web Framework'
        path: "/php",
        defines: [ 'ZEND_DEBUG' ],
        includes: [
            "/php",
            "/php/main",
            "/php/Zend",
            "/php/TSRM",
        ],
        libraries: [ "php5" ],
        linker: [ "-L/php/libs" ],
        imports: [ "/php/libs/libphp5.dylib" ],
    }, 
})
</pre>

        <h3>Extension Paks</h3>
        <p>If an extension is packaged and installed using the
        <a href="http://embedthis.com/products/pak">Pak</a> tool, it may provide a probe script inline in its own
        extension.me file. During configuration, MakeMe will load the extension's MakeMe file can run the probe script to
        determine if the extension should be enabled and configured.</p>

        <a name="create"></a>
        <h2>Creating Probes</h2>
        <p>A MakeMe extension probe is a Javascript file with a <em>.me</em> extension that resides under a 
        <em>makeme/probes</em> directory. MakeMe provides a standard set of probes and these are augmented by per-product
        probes. </p>
        <p>If an extension is defined as a Pak under <em>src/paks</em>, the extension can define its probe directly in its
        '.me' file in a '<em>probe</em>' property. For example:
        <pre>
{
    probe: {
        myext: {
            depends: [ 'libejs', 'zlib', 'sqlite' ],
        },
    }
}
</pre>
        <h2>Extensions Properties</h2>
        <p>The extension property collection may contain properties of any name, but the following properties 
            have special meaning:</p>
        <ul>
            <li>config &mdash; Function run to define extension properties.</li>
            <li>description &mdash; Short, one-sentance description of the extension.</li>
            <li>defines &mdash; Array of C preprocessor definitions for targets using this extension.</li>
            <li>depends &mdash; Array of targets from which to inherit compiler, defines, libraries, libpaths and linker
            settings. May contain extension names.</li>
            <li>discover &mdash; Array of other extensions that should be discovered and utilized by this extension if
                available.</li>
            <li>enable &mdash; Boolean true|false value to enable or disable the extension. May be initially set to a script or
            function that is run to yield a boolean result.  
            <li>generate &mdash; Function to run to define extension properties when generating projects.</li>
            <li>imports &mdash; Libraries, files and resources to import into the local source tree.</li>
            <li>includes &mdash; Array of include paths necessary for targets using this extension.</li>
            <li>libpaths &mdash; Array of linker library search paths for targets using this extension.</li>
            <li>libraries &mdash; Array of required libraries for targets using this extension.</li>
            <li>linker &mdash; Array of linker options for targets using this extension.</li>
            <li>name &mdash; Extension name. Should equal the extension collection property name..</li>
            <li>extensions &mdash; Array of other extensions that must be available for this extension to be enabled.</li>
            <li>path &mdash; Path to primary extension resource or directory. May be the path to the binary for tools.</li>
        </ul>
        <h2>Referencing Extensions in Targets</h2>
        <p>If a target specifies an extension in its <em>depends</em> property, and the extension is found and
        enabled, then the extension properties: defines, includes, libraries, linker and libpaths, will be inherited by the
        target. </p>
        <p>If the target specifies the extension via its <em>extensions</em> property and the extension is not enabled, then the
        target will (silently) be omitted from the build. If the extension is enabled, the target will be built.</p>
        <p>For example, consider the earlier PHP extension definition, then a target desiring to use this php extension
         could be specified like this:</p>
<pre>
app: {
    type: 'exe',
    sources: 'app.c',
    <b>depends: ['php']</b>,
    <b>extensions: ['php']</b>,
},
</pre>
        <p>MakeMe will automatically import the libphp5 library into the local tree at configure time. Because of the
        <em>depends</em> property, MakeMe will add the PHP compiler definitions when compiling app.c and linking with the PHP
        library.</p> 
        <p>If the PHP extension is disabled, the application will not be built.</p>

        <a name="api"></a>
        <h2>Extension API</h2>
        <p>An extension is defined by creating properties in the MakeMe DOM. While this can be done directly, it is
        easier to use the 
        <a href="../../../api/makeme/me.html#extension">Me.extension</a> API. This takes
        an extension description in the form of set of properties. The description specifies the name of the extension and a
        short, single-line description for the extension. </p>
<pre>
<b>Me.extension({</b>
    mydemo: {
        description: 'My demo',
        path: '/usr/local/myview,
    },
})
</pre>
        <p>The extension will typically define a path which represents the directory to the extension or the path to a
        program. The description may also provide libraries, library paths, compiler definitions, and include directories.
        An extension may define any of these standard properties, or it may define any custom property it chooses.
        For example:</p>
<pre>
Me.extension({
    ejs: {
        description: 'Ejscript Language',
        path: probe('src/deps/ejs/ejsLib.c'),
        <b>libraries: [ 'mpr', 'http', 'pcre' ],
        defines: [ 'EJS_DEBUG' ],
        favoriteColor: 'blue',</b>
    },
})
</pre>
        <h3>Extension Path</h3>
        <p>The extension path should be the filename of the program if the extension represents a simple tool (like zip). Or it
        should be the directory to the extension if it represents something more complex like an SDK. The
        path may be a simple string or path, or it may be a function that returns the path for the extension. If
        path is set to a function, it will be invoked with the extension object as its argument. For example:</p>
        <pre>
Me.extension({
    lib: {
        description: 'Library Archive Tool',
        path: function (extension) {
            return probe('ar', { fullpath: true, search: me.extensions.compiler.search })
        },
        extensions: ['compiler'],
    },
})
</pre>
        <p>The <a href="../../../api/makeme/global.html#probe">probe()</a> API may be used to search the system for a program or
        extension resource. See below for more details.  Note that the probe API may be used directly and not nested inside a
        function. For example:</p>
        <pre>
Me.extension({
    lib: {
        description: 'Library Archive Tool',
        <b>path: probe('ar', { fullpath: true })</b>
    },
})
</pre>
        <p>If configure is run and an extension is explicitly requested with a path, that path is provided to the extension in
            its <em>extension.withpath</em> property. For example:</p>
        <pre>me -configure . -with NAME=/path</pre>
        <p>The extension script can then access the requested path via <em>extension.withpath</em>. A common pattern for 
            probing for extension resources is to use the <em>withpath</em> as the default before probing:</p>
            <pre>path: function (extension) {
    let name = extension.withpath || 'programName'
    return probe(name)
},  
</pre>
        <h3>Exceptions</h3>
        <p>If an exception is thrown by any code in the extension probe, the exception will be caught and the extension will be
        disabled. This is a common pattern, to throw exceptions if the extension cannot be fully configured and enabled.</p>
        <h3>The <a href="../../../api/makeme/global.html#program">program()</a> API</h3>
        <p>If you wish to design an extension for a simple command line tool, use the <em>program</em> function to 
            search and define the tool. This works if the tool is accessible using the current PATH definition.
<pre>Me.program('zip', 'Zip utility')</pre>
            <p>The program function searches for Zip and defines the extension if zip can be found.</p>
            <h3>The <a href="../../../api/makeme/global.html#probe">probe()</a> API</h3>
        <p>The probe function is useful to search for a program on the system. It searches for a named program
        and takes options for the search path (search), the default to return if the program cannot be found (default), and
        whether to return the full path or just the dirname portion (fullpath).</p>
         
<pre>probe('gzip', { 
    search: ['/bin', '/usr/bin' ],
    default: 'bin/gzip'
})
</pre>
        <h2>Importing Standard Extensions</h2>
        <p>For developers who wish to <i>freeze</i> the MakeMe support for their product and guarantee the version
        of MakeMe they have designed for, the MakeMe configuration can be imported into the product source tree via:</p>
        <pre>me -import</pre>
        <p>This will copy the entire MakeMe <em>makeme</em> directory into the local source. This copied configuration
        will be used by MakeMe in preference over the install MakeMe files.  The various MakeMe extensions and operating system
        configuration can be modified once imported.</p>
        <p>Under the <em>makeme</em> directory will be the primary MakeMe script <em>me.es</em> and its compiled form
        <em>me.mod</em>. If you need to hack me.es, remove the me.mod file and MakeMe will utilize your modifications.
        When ready, you can compile me.es to create a new me.mod via:</p>
        <pre>ejsc --optimize 9 --out me.mod me.es</pre>
        <a name="samples"></a>
        <h2>Samples</h2>
        <p>The standard extension probes are a good source of samples for how to create extension probes. 
        View in the repository at 
            <a href="https://github.com/embedthis/makeme/tree/master/makeme/probes">MakeMe Extensions Probes</a>.</p>
        <h2>Generating Projects</h2>
        <p>When generating conditional Makefiles, an extension cannot know in advance what resources will be available on
            the system where the Makefile will be run. So the extension script cannot sleuth the system to determine the
            appropriate configuration. MakeMe addresses the conundrum, by providing a separate <em>generate</em> 
            property. This may be set to a function that is invoked for the extension to create a default configuration.</p>
            <p>For example, this defines a generic MatrixSSL configuration. When the user runs the Makefile, they
                can supply the path to MatrixSSL via the ME_EXT_MATRIXSSL_PATH make variable.</p>
            <pre>
matrixssl: {
    generate: function (ext) {
        ext.path = 'PLEASE-SET:ME_EXT_MATRIXSSL_PATH'
        ext.libpaths = [ '$(ME_EXT_MATRIXSSL_PATH)' ]
        ext.includes = [ 
            '$(ME_EXT_MATRIXSSL_PATH)', 
            '$(ME_EXT_MATRIXSSL_PATH)/matrixssl' 
        ]
        if (me.platform.os == 'windows') {
            ext.libraries = [ 'matrixssl.lib' ]
        } else {
            ext.libraries = [ 'matrixssl' ]
        }
    },
    description: 'MatrixSSL',
}
</pre>
        <p>When generating projects, the <em>config</em> property function will not be invoked nor will any
            extension <em>path</em> property functions be called.</p>
        </div>
    </div>
<!-- BeginDsi "dsi/bottom.html" -->
	<div class="bottom">
		<p class="footnote"> 
            <a href="../../../product/copyright.html" >&copy; Embedthis Software LLC, 2003-2014. 
            All rights reserved. Embedthis MakeMe, Ejscript and Appweb are trademarks of Embedthis Software LLC.</a>
		</p>
	</div>
    <script src="http://www.google.com/jsapi" type="text/javascript"></script>
    <script type="text/javascript"> 
      google.load('search', '1', {language : 'en'});
      google.setOnLoadCallback(function() {
        var customSearchControl = new google.search.CustomSearchControl(
          'partner-pub-9935546676162772:ysvxxv4n9rx');

        customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
        var options = new google.search.DrawOptions();
        options.enableSearchboxOnly("http://embedthis.com/search.html");
        customSearchControl.draw('cse-search-form', options);
      }, true);
    </script>
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-179169-5']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</body>
</html>
